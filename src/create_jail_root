#!/bin/sh

echo_stderr () {
	echo "$*" >&2
}

echo_verbose () {
	if [ $verbose -ne 0 ]; then
		echo "$*"
	fi
}


show_usage_and_exit ()  {
	echo_stderr "Usage: $0 <target-directory>"
	exit 1
}


download_file () {
	url=$1
	output_dir=$2
	echo "Downloading $1"
	fetch -q -m -o "$output_dir" "$url" 
	if [ $? -ne 0 ]; then
		echo_stderr "Unable to download $1"
		exit 3
	fi

}

verify_checksum () {
	packagefile=$1
	dir=$2
	echo "Verifying checksum for $packagefile"
	checksum=$(grep $packagefile "$dir/MANIFEST"|cut -f 2)
	if [ $? -ne 0 -o -z "$checksum" ]; then
		echo_stderr "Unable to find checksum for $packagefile in $dir/MANIFEST"
		exit 4
	fi
	new_checksum=$(/sbin/sha256 -q -c $checksum "$dir/$packagefile")
	if [ $? -ne 0 ]; then
		echo_stderr "Computed checksum $new_checksum does not match expected checksum $checksum - aborting"
		exit 4
	fi

}

target_directory=""
release=""
architecture=""
verbose=0
dryrun=0
mirror="ftp://ftp.de.freebsd.org"
packages="base lib32"
cache_dir=/var/tmp

BIN=$(dirname "$0")

do_all=1
do_download=0
do_verify=0
do_extract=0
do_update=0

# parse options
while getopts "a:nr:vDEUV" opt; do
	case $opt in
		a)
			architecture="$OPTARG"
			;;
		n)
			dryrun=1
			;;
		r)
			release="$OPTARG"
			;;
		v)
			verbose=1
			;;
		D) 
			do_all=0
			do_download=1
			;;
		E)
			do_all=0
			do_extract=1
			;;
		U)
			do_all=0
			do_update=1
			;;
		V)
			do_all=0
			do_verify=1
			;;
		\?)
			show_usage_and_exit
			;;
		:)
			echo_stderr "Option -$OPTARG requires an argument."
			show_usage_and_exit
			;;
	esac
done

shift "$((OPTIND-1))" # Shift off the options and optional --.

if [ $# -eq 1 ]; then
	target_directory=$1
fi

if [ -z "$release" ]; then
	echo_stderr "No release specified (-r)"
	show_usage_and_exit
fi
echo_verbose "Release: $release"

if [ -z "$architecture" ]; then
	echo_stderr "No architecture specified (-a)"
	show_usage_and_exit
fi
echo_verbose "Architecture: $architecture"

if [ -z "$target_directory" ]; then
	echo_stderr "No target directory specified"
	show_usage_and_exit
fi
echo_verbose "Target directory: $target_directory"

if test ! -d "$target_directory"; then 
	echo "ERROR: target directory '$target_directory' does not exist"
	exit 2
fi

echo_verbose "Mirror: $mirror"

if [ $verbose -ne 0 ]; then
	echo_verbose "Packages:"
	for package in $packages; do
		echo_verbose " - $package"
	done
fi

if [ $dryrun -ne 0 ]; then
	echo "Dry run only - not doing anything"
	exit 0
fi



ftp_dir="$mirror/pub/FreeBSD/releases/$architecture/$architecture/$release"

release_dir="$cache_dir/$architecture/$release"
mkdir -p "$release_dir"

if [ $do_all -eq 1 -o $do_download -eq 1 ]; then
	download_file "$ftp_dir/MANIFEST" "$release_dir"
	for package in $packages; do
		download_file "$ftp_dir/$package.txz" "$release_dir"
	done
fi

if [ $do_all -eq 1 -o $do_verify -eq 1 ]; then
	for package in $packages; do
		verify_checksum "$package.txz" "$release_dir"
	done
fi

if [ $do_all -eq 1 -o $do_extract -eq 1 ]; then
	for package in $packages; do
		echo "Extracting $package"
		tar xf "$release_dir/$package.txz" -C "$target_directory" 
		if [ $? -ne 0 ]; then
			echo_stderr "Unable to extract $release_dir/$package.txz"
			exit 5
		fi
	done
	# save architecture for future reference
	echo $architecture > "$target_directory/etc/jail_architecture"

fi

if [ $do_all -eq 1 -o $do_update -eq 1 ]; then
	echo "Running freebsd-update"
	old_version=$("$target_directory/bin/freebsd-version" -u)
	PAGER=cat "$BIN/freebsd-update-jail" $target_directory fetch install > /dev/null
	if [ $? -ne 0 ]; then
		echo_stderr "freebsd-update failed"
		exit 6
	fi
	new_version=$("$target_directory/bin/freebsd-version" -u)
	echo "Updated $target_directory from $old_version to $new_version"
fi

